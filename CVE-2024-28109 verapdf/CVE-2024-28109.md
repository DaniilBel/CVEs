# Обзор #

## Описание уязвимости на github asvisory: ##
https://github.com/veraPDF/veraPDF-library/security/advisories/GHSA-qxqf-2mfx-x8jw

## Описание уязвимости: ##
Выполнение проверок политик с использованием пользовательских файлов Schematron вызывает преобразование XSL, которое теоретически может привести к уязвимости удаленного выполнения кода (RCE).

## public метод пакета приводящий к уязвимости ##

### class XsltTransformer ###
~~~java
public static void transform(InputStream source, InputStream xslt, PrintWriter destination, Map<String, String> arguments)
~~~

### Репозиторий проекта с уязвимостью: ###
https://github.com/veraPDF/veraPDF-library

## PoC: ##
~~~java
@Test
    public void testXsltTransformerSecureFactory() throws Exception {
        Field f = XsltTransformer.class.getDeclaredField("factory");
        f.setAccessible(true);
        TransformerFactory factory = (TransformerFactory) f.get(null);

        assertTrue(factory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING));
        assertEquals("file",
                factory.getAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET));
    }

    @Test(expected = TransformerConfigurationException.class)
    public void testMaliciousXsltBlocked() throws Exception {
        // Простейший "враждебный" XSLT, пытающийся импортировать /etc/passwd
        String maliciousXsl =
                "<?xml version=\"1.0\"?>"
                        + "<xsl:stylesheet version=\"1.0\" xmlns:xsl=\"http://www.w3.org/1999/XSL/Transform\">"
                        +   "<xsl:template match=\"/\">"
                        +     "<xsl:import href=\"file:///etc/passwd\"/>"
                        +   "</xsl:template>"
                        + "</xsl:stylesheet>";

        try (ByteArrayInputStream xmlSource = new ByteArrayInputStream(
                "<root/>".getBytes(StandardCharsets.UTF_8));
             ByteArrayInputStream xsltSource = new ByteArrayInputStream(
                     maliciousXsl.getBytes(StandardCharsets.UTF_8));
             StringWriter writer = new StringWriter()) {

            XsltTransformer.transform(xmlSource, xsltSource,
                    new PrintWriter(writer), null);
        }
    }
~~~

## Коммиты, исправившие уязвимость: ##
https://github.com/veraPDF/veraPDF-library/commit/9386ecbe1a1d1fb9e886d19df28851ed07890d9f
