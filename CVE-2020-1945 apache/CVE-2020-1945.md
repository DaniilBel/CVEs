# Обзор #

## Описание уязвимости на github asvisory: ##
https://github.com/advisories/GHSA-4p6w-m9wc-c9c9

## Описание уязвимости: ##
Apache Ant 1.1 до 1.9.14 и 1.10.0 до 1.10.7 использует временный каталог по умолчанию, определенный системным свойством Java java.io.tmpdir для нескольких задач, и, таким образом, может привести к утечке конфиденциальной информации. Задачи fixcrlf и replaceregexp также копируют файлы из временного каталога обратно в дерево сборки, позволяя злоумышленнику внедрять измененные исходные файлы в процесс сборки.

## public метод пакета приводящий к уязвимости ##
CVE-2020-1945 - FileUtils.createTempFile(String, String, File)

### class FixCRLF ###
~~~java
private void processFile(String file)
~~~

Этот метод вызывает внутри себя FileUtils.createTempFile, который создаёт файл и не устанавливает права доступа, полагаясь на системные настройки

### Репозиторий проекта с уязвимостью: ###
https://github.com/apache/ant

## PoC: ##
~~~java
public static void main(String[] args) throws IOException {
        // Создание временного каталога для исходных файлов
        Path srcDir = Files.createTempDirectory("ant-test-src");
        System.out.println("Исходный каталог: " + srcDir);

        // Создание тестового файла
        Path testFile = srcDir.resolve("test.txt");
        Files.write(testFile, Arrays.asList("Hello", "World"), StandardCharsets.UTF_8);

        // Получение системного временного каталога
        String tempDirPath = System.getProperty("java.io.tmpdir");
        Path tempDir = Paths.get(tempDirPath);
        System.out.println("Временный каталог: " + tempDir);

        // Список файлов до выполнения задачи
        Set<String> before = listTempFiles(tempDir, "fixcrlf");

        // Настройка проекта Ant
        Project project = new Project();
        project.init();

        // Создание задачи FixCRLF
        FixCRLF fixcrlf = new FixCRLF();
        fixcrlf.setProject(project);
        fixcrlf.setSrcdir(srcDir.toFile());
        fixcrlf.setIncludes("test.txt");

        // Выполнение задачи
        fixcrlf.execute();

        // Список файлов после выполнения
        Set<String> after = listTempFiles(tempDir, "fixcrlf");

        // Поиск новых файлов
        Set<String> newFiles = after.stream().filter(f -> !before.contains(f)).collect(Collectors.toSet());

        // Проверка прав доступа
        for (String file : newFiles) {
            Path path = tempDir.resolve(file);
            try {
                Set<PosixFilePermission> perms = Files.getPosixFilePermissions(path);
                if (perms.contains(PosixFilePermission.GROUP_READ) || perms.contains(PosixFilePermission.OTHERS_READ)) {
                    System.out.println("Временный файл доступен для чтения другими: " + path);
                } else {
                    System.out.println("Временный файл недоступен для чтения другими: " + path);
                }
            } catch (IOException e) {
                System.err.println("Ошибка проверки прав для " + path + ": " + e.getMessage());
            }
        }

        // Очистка
        Files.delete(testFile);
        Files.delete(srcDir);
    }

    private static Set<String> listTempFiles(Path dir, String prefix) throws IOException {
        try (Stream<Path> stream = Files.list(dir)) {
            return stream
                    .filter(path -> path.getFileName().toString().startsWith(prefix))
                    .map(path -> path.getFileName().toString())
                    .collect(Collectors.toSet());
        }
    }
~~~

## Коммиты, исправившие уязвимость: ##
https://github.com/apache/ant/commit/9c1f4d905da59bf446570ac28df5b68a37281f35
